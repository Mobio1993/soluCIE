<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Historique – SoluCIE (Complexe Hôtelier Emmanuella)</title>
  <meta name="color-scheme" content="dark">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Thème commun -->
  <link rel="stylesheet" href="./style2-cie.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <i class="bi bi-lightning-charge text-primary fs-4 me-2" aria-hidden="true"></i>
        <span class="fw-bold">SoluCIE</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Basculer la navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse mt-3 mt-lg-0" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a href="index.html" class="nav-link">Dashboard</a></li>
          <li class="nav-item"><a href="recharger.html" class="nav-link">Recharger</a></li>
          <li class="nav-item"><a href="compteur.html" class="nav-link">Compteurs</a></li>
          <!-- ✅ Actif sur CETTE page -->
          <li class="nav-item"><a href="historique.html" class="nav-link active" aria-current="page">Historique</a></li>
          <li class="nav-item"><a href="contact.html" class="nav-link">Contact</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <section class="hero pt-4 pb-2">
    <div class="container">
      <div class="glow-circle" aria-hidden="true">
        <i class="bi bi-clock-history"></i>
      </div>
      <h1 class="mb-2">Historique des transactions</h1>
      <p class="mt-2">
        Suivez en temps réel les recharges effectuées : montant, moyen de paiement, compteur, et statut.
      </p>
    </div>
  </section>

  <!-- FILTRES + ACTIONS -->
  <section class="pb-4">
    <div class="container">
      <div class="card p-3 mb-3">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-4">
            <label for="search" class="form-label">Recherche</label>
            <input id="search" type="text" class="form-control" placeholder="Montant, compteur, paiement…" />
          </div>
          <div class="col-12 col-sm-6 col-md-4">
            <label class="form-label">Période</label>
            <div class="d-flex gap-2 flex-wrap range-group">
                <button class="btn btn-outline-light btn-sm" data-range="today">Aujourd'hui</button>
                <button class="btn btn-outline-light btn-sm" data-range="7">7j</button>
                <button class="btn btn-outline-light btn-sm" data-range="30">30j</button>
            </div>
            </div>
          <div class="col-6 col-md-2">
            <label for="status" class="form-label">Statut</label>
            <select id="status" class="form-select">
              <option value="">Tous</option>
              <option value="soumis">Soumis</option>
              <option value="réussi">Réussi</option>
              <option value="échoué">Échoué</option>
            </select>
          </div>
          <div class="col-12 col-md-4 d-grid d-md-flex justify-content-md-end">
            <button id="exportCsv" class="btn btn-success"><i class="bi bi-filetype-csv me-2"></i>Exporter CSV</button>
          </div>
        </div>
      </div>

      <!-- TABLEAU -->
      <div class="card p-0">
        <div class="table-responsive">
          <table class="table table-dark table-hover table-borderless align-middle mb-0" id="tableTx">
            <thead>
              <tr>
                <th style="min-width:140px">Date/Heure</th>
                <th>Compteur</th>
                <th class="text-end">Montant</th>
                <th>Paiement</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody aria-live="polite">><!-- injecté par JS --></tbody>
          </table>
        </div>
        <div id="emptyState" class="text-center py-5 d-none">
          <div class="mb-2"><i class="bi bi-inbox fs-1 text-muted"></i></div>
          <p class="text-small-note mb-2">Aucune transaction trouvée pour les filtres sélectionnés.</p>
          <a href="recharger.html" class="btn btn-primary btn-sm"><i class="bi bi-lightning-fill me-1"></i>Effectuer une recharge</a>
        </div>
      </div>
    </div>
  </section>

  <footer>
    © <span id="year"></span> Complexe Hôtelier Emmanuella | Système de Recharge Électrique Intelligente
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  <script defer>
    // --- Constantes de stockage partagé
    const TX_KEY = 'solucie.transactions';

    // --- Utilitaires
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    function readTransactions(){
      try{
        const raw = localStorage.getItem(TX_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function writeTransactions(arr){
      localStorage.setItem(TX_KEY, JSON.stringify(arr));
    }

    // --- Rendu
    const tbody = document.querySelector('#tableTx tbody');
    const emptyState = $('#emptyState');

    function formatAmount(x){
      return Intl.NumberFormat('fr-FR').format(Number(x||0)) + ' FCFA';
    }
    function formatDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString('fr-FR');
      }catch{ return iso; }
    }

    function badgeForStatus(st){
      const s = (st||'').toLowerCase();
      if(s === 'réussi') return '<span class="badge text-bg-success">réussi</span>';
      if(s === 'échoué') return '<span class="badge text-bg-danger">échoué</span>';
      return '<span class="badge text-bg-secondary">soumis</span>';
    }

    function applyFilters(items){
      const q = $('#search').value.trim().toLowerCase();
      const st = $('#status').value;
      const active = document.querySelector('[data-range].active');
      let filtered = items;

      if(q){
        filtered = filtered.filter(t =>
          String(t.montant).includes(q) ||
          (t.compteurNom||'').toLowerCase().includes(q) ||
          (t.compteurNumero||'').toLowerCase().includes(q) ||
          (t.paiement||'').toLowerCase().includes(q)
        );
      }
      if(st){ filtered = filtered.filter(t => (t.statut||'').toLowerCase() === st); }

      if(active){
        const r = active.getAttribute('data-range');
        const now = new Date();
        let after = null;
        if(r === 'today'){
          after = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        }else{
          const days = parseInt(r, 10);
          after = new Date(now.getTime() - days*24*3600*1000);
        }
        filtered = filtered.filter(t => new Date(t.date) >= after);
      }

      return filtered.sort((a,b)=> new Date(b.date) - new Date(a.date));
    }

    function render(){
        const items = applyFilters(readTransactions());
        tbody.innerHTML = '';

        if(!items.length){
            emptyState.classList.remove('d-none');
            return;
        }
        emptyState.classList.add('d-none');

        for(const t of items){
            const tr = document.createElement('tr');
            tr.className = 'tx-row';

            // Construire les TD avec leurs data-th (labels)
            const tdDate = document.createElement('td');
            tdDate.setAttribute('data-th', 'Date/Heure');
            tdDate.textContent = formatDate(t.date);

            const tdCmp = document.createElement('td');
            tdCmp.setAttribute('data-th', 'Compteur');
            tdCmp.innerHTML = `
            <div class="fw-semibold">${t.compteurNom||'—'}</div>
            <div class="text-small-note">${t.compteurNumero||''}${t.zone? ' · '+t.zone.toUpperCase():''}</div>
            `;

            const tdMontant = document.createElement('td');
            tdMontant.setAttribute('data-th', 'Montant');
            tdMontant.className = 'text-end';
            tdMontant.textContent = formatAmount(t.montant);

            const tdPay = document.createElement('td');
            tdPay.setAttribute('data-th', 'Paiement');
            tdPay.className = 'text-uppercase';
            tdPay.textContent = String(t.paiement||'').replace('-', ' ');

            const tdStatut = document.createElement('td');
            tdStatut.setAttribute('data-th', 'Statut');
            tdStatut.innerHTML = badgeForStatus(t.statut);

            tr.append(tdDate, tdCmp, tdMontant, tdPay, tdStatut);
            tbody.appendChild(tr);
        }
    }

    // Fonction debounce

     function debounce(fn, delay = 200){
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
      };
    }



    // --- Export CSV simple
    function exportCsv(){
      const rows = [['date','compteur_nom','compteur_numero','zone','montant','paiement','statut']];
      for(const t of applyFilters(readTransactions())){
        rows.push([t.date, t.compteurNom||'', t.compteurNumero||'', t.zone||'', t.montant||'', t.paiement||'', t.statut||'']);
      }
      const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'solucie_transactions.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // --- Événements UI
    document.addEventListener('DOMContentLoaded', () => {
      // Année footer
      const yearSpan = document.getElementById('year');
      if (yearSpan) yearSpan.textContent = new Date().getFullYear();

      // Lien actif auto (sécurité)
      const path = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.navbar .nav-link').forEach(a => {
        const href = a.getAttribute('href');
        if(href && href === path){ a.classList.add('active'); a.setAttribute('aria-current', 'page'); }
      });

      // Filtres
      // ✅ Filtres avec debounce pour la recherche
        $('#status').addEventListener('input', render);
        $('#search').addEventListener('input', debounce(render, 180));
        $$('[data-range]').forEach(btn => btn.addEventListener('click', () => {
        $$('[data-range]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render();
      }));

      $('#exportCsv').addEventListener('click', exportCsv);

      render();
    });

    // --- Synchronisation temps réel entre onglets
    window.addEventListener('storage', (e) => {
      if(e.key === TX_KEY){ render(); }
    });
  </script>
</body>
</html>
