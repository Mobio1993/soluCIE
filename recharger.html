<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recharger â€“ SoluCIE (Complexe HÃ´telier Emmanuella)</title>
  <meta name="color-scheme" content="dark">

  <!-- Perf: prÃ©connexion fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- ThÃ¨me -->
  <link rel="stylesheet" href="./style2-cie.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <i class="bi bi-lightning-charge text-primary fs-4 me-2" aria-hidden="true"></i>
        <span class="fw-bold">SoluCIE</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Basculer la navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse mt-3 mt-lg-0" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a href="index.html" class="nav-link">Dashboard</a>
          </li>
          <li class="nav-item">
            <a href="recharger.html" class="nav-link active" aria-current="page">Recharger</a>
          </li>
          <li class="nav-item">
            <a href="compteur.html" class="nav-link">Compteurs</a>
          </li>
          <li class="nav-item">
            <a href="historique.html" class="nav-link">Historique</a>
          </li>
          <li class="nav-item">
            <a href="contact.html" class="nav-link">Contact</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main id="content" class="py-5" tabindex="-1">
    <section id="recharge">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-md-7 col-lg-6">
            <div class="card p-4 mb-5 elevate-on-hover">
              <h4 class="text-center mb-3 text-white fw-bold">
                <i class="bi bi-battery-charging me-2 text-primary" aria-hidden="true"></i>
                Recharge automatique
              </h4>

              <form id="rechargeForm" novalidate>
                <div class="mb-3">
                  <label for="selectCompteur" class="form-label">Compteur</label>
                  <select id="selectCompteur" class="form-select" required>
                    <option value="" selected disabled>SÃ©lectionnerâ€¦</option>
                    <!-- options injectÃ©es par JS -->
                  </select>
                  <div class="invalid-feedback">Choisissez un compteur.</div>

                  <!-- ðŸ‘‡ AJOUTE CE BLOC ICI -->
                  <div id="compteurDetails"
                      class="alert alert-glass mt-2 d-none small rounded-3 border border-primary"
                      role="note" aria-live="polite">
                    <i class="bi bi-info-circle me-2" aria-hidden="true"></i>
                    <span id="compteurDetailsText">â€”</span>
                  </div>

                </div>

                <div class="mb-3">
                  <label for="montant" class="form-label">Montant Ã  recharger (FCFA)</label>
                  <input
                    id="montant"
                    type="number"
                    class="form-control"
                    placeholder="Ex : 5000"
                    min="1000"
                    step="500"
                    inputmode="numeric"
                    autocomplete="off"
                    required
                  >
                  <div class="form-text text-small-note">Minimum 1 000 FCFA â€” paliers de 500 FCFA.</div>
                  <div class="invalid-feedback">Saisissez un montant valide (â‰¥ 1 000 et multiple de 500).</div>
                </div>

                <div class="mb-4">
                  <label for="paiement" class="form-label">Mode de paiement</label>
                  <select id="paiement" class="form-select" required>
                    <option value="" selected disabled>Choisirâ€¦</option>
                    <option value="orange-money">Orange Money</option>
                    <option value="mtn-money">MTN Money</option>
                    <option value="moov-money">Moov Money</option>
                    <option value="wave">Wave</option>
                  </select>
                  <div class="invalid-feedback">SÃ©lectionnez un mode de paiement.</div>
                </div>

                <div class="d-grid">
                  <button id="btnSubmit" type="submit" class="btn btn-primary py-2 fw-semibold">
                    <span class="btn-label">
                      <i class="bi bi-lightning-charge me-2" aria-hidden="true"></i>
                      Recharger maintenant
                    </span>
                    <span class="btn-spinner d-none" aria-hidden="true">
                      <span class="spinner-border spinner-border-sm align-text-top" role="status"></span>
                      <span class="ms-2">Traitementâ€¦</span>
                    </span>
                  </button>
                </div>
              </form>

              <!-- âœ… Mini Progress Bar ajoutÃ©e ici -->
                <div id="progressLine" class="progress d-none mt-3" style="height:4px;">
                  <div class="progress-bar progress-bar-striped progress-bar-animated"></div>
                </div>

              <div id="statusMsg"
                   class="mt-3 text-center fw-semibold"
                   role="status"
                   aria-live="polite">
              </div>
            </div>

            <p class="text-center text-small-note">
              Astuce : ajoutez/supprimez vos compteurs dans la page <a href="compteur.html" class="link">Compteurs</a>.
            </p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    Â© <span id="year"></span> Complexe HÃ´telier Emmanuella | SystÃ¨me de Recharge Ã‰lectrique Intelligente
  </footer>

  <!-- Scripts -->
 <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script defer>
  // --- DonnÃ©es / localStorage
  const SEED_COMPTEURS = [
    { nom: 'Compteur_Night_Club', numero: '24212919633', zone: 'hotel', statut: 'actif' },
  ];
  const storageKey = 'solucie.compteurs';

  function readCompteurs() {
    try {
      const raw = localStorage.getItem(storageKey);
      const arr = raw ? JSON.parse(raw) : null;
      if (!Array.isArray(arr) || !arr.length) return SEED_COMPTEURS;
      return arr;
    } catch { return SEED_COMPTEURS; }
  }
  function getActifs() {
    return readCompteurs().filter(c => (c?.statut || '').toLowerCase() === 'actif');
  }

  // --- Helpers
  const $ = (sel) => document.querySelector(sel);

  // RÃ©fs DOM (dÃ©clarÃ©es ici, assignÃ©es dans init pour garantir qu'elles existent)
  let selectCompteur, rechargeForm, statusMsg, btnSubmit;
  let compteurDetails, compteurDetailsText;
  let progressLine, progressBar;

  // Timer progression
  let progressTimer = null;

  // --- UI
  function renderSelectCompteurs() {
    if (!selectCompteur) return;
    // Supprime toutes les options sauf la disabled
    selectCompteur.querySelectorAll('option:not([disabled])').forEach(o => o.remove());
    getActifs().forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.numero;
      opt.textContent = c.nom;
      selectCompteur.appendChild(opt);
    });
    // Remet le placeholder
    selectCompteur.value = "";
  }

  function isMontantValide(v) {
    const n = Number(v);
    return Number.isFinite(n) && n >= 1000 && n % 500 === 0;
  }

  function setStatus(type, msg) {
    statusMsg.className = 'mt-3 text-center fw-semibold';
    if (type === 'error') statusMsg.classList.add('text-danger');
    if (type === 'success') statusMsg.classList.add('text-success');
    statusMsg.textContent = msg;
  }

  function setLoading(isLoading) {
    if (!btnSubmit || !progressLine || !progressBar) return;

    btnSubmit.disabled = isLoading;
    btnSubmit.querySelector('.btn-label')?.classList.toggle('d-none', isLoading);
    btnSubmit.querySelector('.btn-spinner')?.classList.toggle('d-none', !isLoading);

    if (isLoading) {
      progressLine.classList.remove('d-none');
      progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
      let pct = 10;
      progressBar.style.width = pct + '%';
      progressBar.setAttribute('aria-valuenow', pct);

      // Simulation d'avancement (jusqu'Ã  90%)
      progressTimer = setInterval(() => {
        pct = Math.min(pct + 8, 90);
        progressBar.style.width = pct + '%';
        progressBar.setAttribute('aria-valuenow', pct);
      }, 200);
    } else {
      // Finir Ã  100%, puis reset et masquer
      if (progressTimer) {
        clearInterval(progressTimer);
        progressTimer = null;
      }
      progressBar.style.width = '100%';
      progressBar.setAttribute('aria-valuenow', 100);

      setTimeout(() => {
        progressLine.classList.add('d-none');
        progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', 0);
      }, 300);
    }
  }

  // --- Transactions (partagÃ© avec historique.html)
  const TX_KEY = 'solucie.transactions';

  function addTransaction(tx){
    try{
      const raw = localStorage.getItem(TX_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      arr.push(tx);
      localStorage.setItem(TX_KEY, JSON.stringify(arr));
    }catch(e){
      console.error('Impossible d\'Ã©crire la transaction', e);
    }
  }

  // --- Soumission
  function handleSubmit(e) {
    e.preventDefault();

    const montantEl = $('#montant');
    const paiementEl = $('#paiement');

    rechargeForm.classList.add('was-validated');

    if (!selectCompteur.value || !paiementEl.value || !isMontantValide(montantEl.value)) {
      setStatus('error', 'Veuillez complÃ©ter correctement les informations (montant multiple de 500).');
      return;
    }

    // Simuler lâ€™appel backend / HES
    setLoading(true);
    setStatus('success', 'âœ… Rechargement en cours de traitementâ€¦');

    setTimeout(() => {
      setLoading(false);
      setStatus('success', 'âœ… Rechargement soumis. Vous recevrez une confirmation sous peu.');

      // RÃ©cupÃ©rer infos choisies
      const c = getActifs().find(x => x.numero === selectCompteur.value);
      addTransaction({
        id: Date.now().toString(36) + Math.random().toString(36).slice(2,7),
        date: new Date().toISOString(),
        compteurNom: c ? c.nom : '',
        compteurNumero: c ? c.numero : '',
        zone: c ? c.zone : '',
        montant: Number($('#montant').value),
        paiement: $('#paiement').value,   // ex: "orange-money"
        statut: 'soumis'                  // pourra devenir "rÃ©ussi"/"Ã©chouÃ©" aprÃ¨s retour API
      });


      rechargeForm.reset();
      rechargeForm.classList.remove('was-validated');
      renderSelectCompteurs(); // remet lâ€™option par dÃ©faut
      // TODO: ici, intÃ©grer lâ€™appel rÃ©el Ã  ton API (token + endpoint)
    }, 1200);
  }

  // --- Init
  function init() {
    // RÃ©fÃ©rences DOM
    selectCompteur       = $('#selectCompteur');
    rechargeForm         = $('#rechargeForm');
    statusMsg            = $('#statusMsg');
    btnSubmit            = $('#btnSubmit');
    compteurDetails      = $('#compteurDetails');
    compteurDetailsText  = $('#compteurDetailsText');
    progressLine         = $('#progressLine');
    progressBar          = progressLine?.querySelector('.progress-bar');

    // AnnÃ©e footer
    const yearSpan = document.getElementById('year');
    if (yearSpan) yearSpan.textContent = new Date().getFullYear();

    renderSelectCompteurs();

    if (rechargeForm) {
      rechargeForm.addEventListener('submit', handleSubmit);
    }

    // --- Listeners â€œamÃ©liorationâ€ sÃ©curisÃ©s
    if (selectCompteur) {
      selectCompteur.addEventListener('change', () => {
        const c = getActifs().find(x => x.numero === selectCompteur.value);
        if (!c || !compteurDetails || !compteurDetailsText) return;
        compteurDetails.classList.remove('d-none');
        compteurDetailsText.textContent = `NumÃ©ro : ${c.numero} â€” Zone : ${c.zone.toUpperCase()}`;
      });
    }

    if (btnSubmit) {
      // Petit feedback visuel optionnel au premier rendu
      btnSubmit.classList.add('success');
      setTimeout(() => btnSubmit.classList.remove('success'), 1200);
    }
  }

  document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
